<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, interactive-widget=resizes-content">
  <title>Terminal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%; background: #1a1a2e; color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }
    .toolbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 8px; background: #111127;
      border-bottom: 1px solid #2a2a4a; height: 40px; flex-shrink: 0;
    }
    .toolbar-left { display: flex; align-items: center; gap: 6px; }
    .toolbar-right { display: flex; align-items: center; gap: 6px; }
    .btn-nav {
      background: none; border: 1px solid #3a3a5a; color: #60a5fa;
      font-size: 12px; cursor: pointer; padding: 3px 8px;
      border-radius: 6px; white-space: nowrap;
    }
    .btn-nav:active { background: #1e3a5f; }
    .btn-nav.home { color: #d97706; border-color: #d97706; }
    .btn-logout-sm {
      background: none; border: 1px solid #3a3a5a; color: #888;
      font-size: 12px; cursor: pointer; padding: 3px 8px; border-radius: 6px;
    }
    .toolbar-title {
      font-size: 13px; font-weight: 500; max-width: 120px;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .status-running { background: #22c55e; }
    .status-waiting { background: #eab308; }
    .status-idle { background: #9ca3af; }
    .status-error { background: #ef4444; }
    .gdrive-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .gdrive-dot.mounted { background: #22c55e; }
    .gdrive-dot.unmounted { background: #ef4444; }

    /* Main area */
    .main {
      display: flex; flex-direction: column;
      height: calc(100vh - 40px);
      height: calc(100dvh - 40px);
    }

    /* Terminal output */
    .text-output {
      flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding: 10px 12px;
      font-family: 'Menlo','Monaco','Courier New',courier-new,courier,monospace;
      font-size: 14px; line-height: 1.0; white-space: pre-wrap; word-break: break-word;
      -webkit-user-select: text; user-select: text;
      color: #e0e0e0; background: #1a1a2e;
    }

    /* Extended panel: slides out on input focus */
    .extended-panel {
      max-height: 0; overflow: hidden;
      transition: max-height 0.2s ease-out;
      background: #111127; flex-shrink: 0;
    }
    .extended-panel.open { max-height: 120px; border-top: 1px solid #2a2a4a; }
    .extended-panel.open + .quick-bar { display: none; }

    .shortcut-bar {
      display: flex; gap: 4px; padding: 4px 8px; background: #111127;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    .shortcut-btn {
      background: #1e1e3a; border: 1px solid #3a3a5a; color: #bbb;
      padding: 6px 8px; border-radius: 6px; font-size: 11px;
      white-space: nowrap; cursor: pointer; min-height: 30px; flex-shrink: 0;
      touch-action: manipulation;
    }
    .shortcut-btn:active { background: #2a2a5a; }
    .shortcut-btn.danger { border-color: #7f1d1d; color: #fca5a5; }

    .staged-files {
      display: flex; flex-wrap: wrap; gap: 3px; padding: 3px 8px;
      background: #111127; max-height: 40px; overflow-y: auto;
    }
    .staged-files:empty { display: none; padding: 0; border: none; }
    .file-chip {
      display: flex; align-items: center; gap: 4px;
      background: #1e1e3a; border: 1px solid #3a3a5a;
      border-radius: 12px; padding: 2px 8px; font-size: 11px;
    }
    .file-chip.uploading { border-color: #d97706; }
    .file-chip.done { border-color: #22c55e; }
    .file-chip.error { border-color: #ef4444; }
    .file-chip .remove { cursor: pointer; color: #888; font-size: 14px; margin-left: 2px; }
    .file-chip .size { color: #888; }

    .upload-progress { height: 2px; background: #2a2a4a; }
    .upload-progress:empty { display: none; }
    .upload-progress .bar { height: 100%; background: #d97706; transition: width 0.3s; }

    /* Tier 1: Always-visible quick bar */
    .quick-bar {
      display: flex; gap: 4px; padding: 4px 8px;
      background: #111127; border-top: 1px solid #2a2a4a;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      flex-shrink: 0; flex-wrap: nowrap;
    }
    .qbtn {
      background: #1e1e3a; border: 1px solid #3a3a5a; color: #bbb;
      padding: 4px 10px; border-radius: 6px; font-size: 12px;
      white-space: nowrap; cursor: pointer; flex-shrink: 0;
      min-height: 28px; touch-action: manipulation;
    }
    .qbtn:active { background: #2a2a5a; }

    /* Tier 2: Always-visible input bar */
    .input-bar {
      display: flex; gap: 4px; padding: 6px 8px;
      padding-bottom: calc(6px + env(safe-area-inset-bottom));
      background: #111127;
      align-items: flex-end; flex-shrink: 0;
      flex-wrap: nowrap; overflow: hidden;
    }
    .btn-attach {
      background: none; border: none; color: #888; font-size: 20px;
      cursor: pointer; padding: 4px; min-width: 32px; min-height: 32px;
      display: flex; align-items: center; justify-content: center;
      touch-action: manipulation;
    }
    .btn-attach:active { color: #d97706; }
    .input-bar input[type="text"] {
      flex: 1; min-width: 0; background: #1a1a2e; border: 1px solid #3a3a5a;
      border-radius: 8px; padding: 8px 10px; color: #e0e0e0;
      font-size: 15px; outline: none;
    }
    .input-bar input[type="text"]:focus { border-color: #d97706; }
    .btn-send {
      background: #d97706; border: none; color: #fff;
      padding: 8px 14px; border-radius: 8px; font-size: 14px;
      cursor: pointer; min-width: 42px; touch-action: manipulation;
    }
    .btn-send:disabled { background: #555; cursor: not-allowed; }

    /* ANSI text styles */
    .ansi-bold { font-weight: bold; }
    .ansi-dim { opacity: 0.5; }
    .ansi-italic { font-style: italic; }
    .ansi-underline { text-decoration: underline; }
    .ansi-strike { text-decoration: line-through; }

    .settings-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 100; display: none;
      align-items: center; justify-content: center;
    }
    .settings-overlay.open { display: flex; }
    .settings-panel {
      background: #111127; border: 1px solid #2a2a4a; border-radius: 12px;
      padding: 20px; width: 90%; max-width: 360px;
    }
    .settings-panel h3 { margin-bottom: 16px; color: #d97706; }
    .setting-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #2a2a4a;
    }
    .setting-row:last-child { border: none; }
    .setting-label { font-size: 14px; }
    .setting-desc { font-size: 11px; color: #888; }
    .toggle {
      width: 44px; height: 24px; background: #3a3a5a; border-radius: 12px;
      position: relative; cursor: pointer; transition: background 0.2s;
    }
    .toggle.on { background: #d97706; }
    .toggle::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 20px; height: 20px; background: #fff; border-radius: 50%;
      transition: left 0.2s;
    }
    .toggle.on::after { left: 22px; }
    .btn-close {
      margin-top: 16px; width: 100%; padding: 10px;
      background: #2a2a4a; border: none; color: #e0e0e0;
      border-radius: 8px; font-size: 14px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn-nav home" onclick="goHome()">&#8592;</button>
      <span class="toolbar-title" id="title">...</span>
      <span class="status-dot" id="status-dot"></span>
      <span class="gdrive-dot" id="gdrive-dot" title="GDrive"></span>
    </div>
    <div class="toolbar-right">
      <button class="btn-nav" onclick="toggleSettings()" style="border:none;color:#888;font-size:14px">&#9881;</button>
      <button class="btn-logout-sm" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="main" id="main">
    <div class="text-output" id="text-output"></div>

    <!-- Extended panel: slides out on input focus -->
    <div class="extended-panel" id="extended-panel">
      <div class="shortcut-bar" id="shortcut-bar"></div>
      <div class="staged-files" id="staged-files"></div>
      <div class="upload-progress" id="upload-progress"></div>
    </div>

    <!-- Tier 1: Always-visible quick bar -->
    <div class="quick-bar">
      <button class="qbtn" onclick="sendKey('Tab')">Tab</button>
      <button class="qbtn" onclick="sendKey('BTab')">S-Tab</button>
      <button class="qbtn" onclick="sendKey('Enter')">Enter</button>
      <button class="qbtn" onclick="pasteClipboard()">&#128203;</button>
      <button class="qbtn" onclick="sendKey('Up')">&#8593;</button>
      <button class="qbtn" onclick="sendKey('Down')">&#8595;</button>
    </div>

    <!-- Tier 2: Always-visible input bar -->
    <div class="input-bar">
      <button class="btn-attach" onclick="document.getElementById('file-input').click()">&#128206;</button>
      <input type="file" id="file-input" multiple style="display:none" onchange="handleFiles(this.files)">
      <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none" onchange="handleFiles(this.files)">
      <input type="text" id="cmd-input" placeholder="Type command..." autocomplete="off" autocorrect="off" autocapitalize="off">
      <button class="btn-send" id="btn-send" onclick="sendInput()">&#9654;</button>
    </div>
  </div>

  <div class="settings-overlay" id="settings-overlay" onclick="if(event.target===this)toggleSettings()">
    <div class="settings-panel">
      <h3>Settings</h3>
      <div class="setting-row">
        <div>
          <div class="setting-label">Upload immediately</div>
          <div class="setting-desc">ON = upload on select. OFF = upload on send</div>
        </div>
        <div class="toggle" id="toggle-upload-mode" onclick="toggleUploadMode()"></div>
      </div>
      <button class="btn-close" onclick="toggleSettings()">Close</button>
    </div>
  </div>

  <script>
    var sessionId = window.location.pathname.split('/').pop();
    var BASE = '/console';
    var stagedFiles = [];
    var activeUploads = 0;
    var uploadModeA = true;
    var prevOutput = '';
    var pollTimer = null;
    var fastPollEnd = 0;
    var idleStart = 0;
    var consecutiveErrors = 0;

    // Polling constants
    var POLL_FAST = 300;
    var POLL_NORMAL = 800;
    var POLL_IDLE = 3000;
    var FAST_DURATION = 10000;
    var IDLE_THRESHOLD = 45000;

    try { var sv = localStorage.getItem('gt_upload_mode'); if (sv !== null) uploadModeA = sv === 'A'; } catch(e){}
    document.getElementById('title').textContent = sessionId;
    (function() { if (uploadModeA) document.getElementById('toggle-upload-mode').classList.add('on'); })();

    // ---- ANSI Parser (state machine, 256/truecolor) ----
    var ANSI_STANDARD = [
      '#2e3436','#cc0000','#4e9a06','#c4a000','#3465a4','#75507b','#06989a','#d3d7cf',
      '#555753','#ef2929','#8ae234','#fce94f','#729fcf','#ad7fa8','#34e2e2','#eeeeec'
    ];

    function ansi256ToHex(n) {
      if (n < 16) return ANSI_STANDARD[n];
      if (n >= 232) { var g = 8 + (n - 232) * 10; return 'rgb(' + g + ',' + g + ',' + g + ')'; }
      n -= 16;
      var r = Math.floor(n / 36) * 51;
      var g = Math.floor((n % 36) / 6) * 51;
      var b = (n % 6) * 51;
      return 'rgb(' + r + ',' + g + ',' + b + ')';
    }

    function ansiToHtml(text) {
      var clean = text.replace(/\x1b\][^\x07\x1b]*(?:\x07|\x1b\\)/g, '');
      clean = clean.replace(/\x1b\[\?[0-9;]*[a-zA-Z]/g, '');
      clean = clean.replace(/\x1b\[[0-9;]*[ABCDEFGHJKSTfhlnsu]/g, '');
      clean = clean.replace(/\x1b[()][AB012]/g, '');
      clean = clean.replace(/\x1b[>=]/g, '');
      clean = clean.replace(/\x1b\[?[0-9;]*[^m\x1b]/g, function(m) { return m; });

      var escaped = clean.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

      var result = '';
      var spanOpen = false;
      var fg = null, bg = null;
      var bold = false, dim = false, italic = false, underline = false, strike = false, reverse = false;

      var parts = escaped.split(/\x1b\[([0-9;]*?)m/);
      for (var i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
          result += parts[i];
        } else {
          if (spanOpen) { result += '</span>'; spanOpen = false; }

          var codes = parts[i] === '' ? [0] : parts[i].split(';').map(Number);
          for (var j = 0; j < codes.length; j++) {
            var c = codes[j];
            if (c === 0) { fg = null; bg = null; bold = false; dim = false; italic = false; underline = false; strike = false; reverse = false; }
            else if (c === 1) bold = true;
            else if (c === 2) dim = true;
            else if (c === 3) italic = true;
            else if (c === 4) underline = true;
            else if (c === 7) reverse = true;
            else if (c === 9) strike = true;
            else if (c === 22) { bold = false; dim = false; }
            else if (c === 23) italic = false;
            else if (c === 24) underline = false;
            else if (c === 27) reverse = false;
            else if (c === 29) strike = false;
            else if (c >= 30 && c <= 37) fg = ANSI_STANDARD[c - 30];
            else if (c === 38) {
              if (codes[j+1] === 5 && codes[j+2] !== undefined) { fg = ansi256ToHex(codes[j+2]); j += 2; }
              else if (codes[j+1] === 2 && codes[j+4] !== undefined) { fg = 'rgb(' + codes[j+2] + ',' + codes[j+3] + ',' + codes[j+4] + ')'; j += 4; }
            }
            else if (c === 39) fg = null;
            else if (c >= 40 && c <= 47) bg = ANSI_STANDARD[c - 40];
            else if (c === 48) {
              if (codes[j+1] === 5 && codes[j+2] !== undefined) { bg = ansi256ToHex(codes[j+2]); j += 2; }
              else if (codes[j+1] === 2 && codes[j+4] !== undefined) { bg = 'rgb(' + codes[j+2] + ',' + codes[j+3] + ',' + codes[j+4] + ')'; j += 4; }
            }
            else if (c === 49) bg = null;
            else if (c >= 90 && c <= 97) fg = ANSI_STANDARD[c - 90 + 8];
            else if (c >= 100 && c <= 107) bg = ANSI_STANDARD[c - 100 + 8];
          }

          var sty = '', cls = [];
          var actFg = reverse ? bg : fg;
          var actBg = reverse ? fg : bg;
          if (actFg) sty += 'color:' + actFg + ';';
          if (actBg) sty += 'background:' + actBg + ';';
          if (bold) cls.push('ansi-bold');
          if (dim) cls.push('ansi-dim');
          if (italic) cls.push('ansi-italic');
          if (underline) cls.push('ansi-underline');
          if (strike) cls.push('ansi-strike');

          if (sty || cls.length) {
            result += '<span' + (cls.length ? ' class="' + cls.join(' ') + '"' : '') + (sty ? ' style="' + sty + '"' : '') + '>';
            spanOpen = true;
          }
        }
      }
      if (spanOpen) result += '</span>';
      return result;
    }

    // ---- Adaptive Polling ----
    function startPoll() {
      if (pollTimer) return;
      idleStart = Date.now();
      schedulePoll();
      fetchOutput();
    }

    function schedulePoll() {
      var now = Date.now(), interval;
      if (consecutiveErrors >= 3) {
        interval = POLL_IDLE;
      } else if (now < fastPollEnd) {
        interval = POLL_FAST;
      } else if (now - idleStart > IDLE_THRESHOLD) {
        interval = POLL_IDLE;
      } else {
        interval = POLL_NORMAL;
      }
      pollTimer = setTimeout(function() {
        pollTimer = null;
        fetchOutput();
        schedulePoll();
      }, interval);
    }

    function stopPoll() { if (pollTimer) { clearTimeout(pollTimer); pollTimer = null; } }

    function triggerFastPoll() {
      fastPollEnd = Date.now() + FAST_DURATION;
      idleStart = Date.now();
      stopPoll();
      schedulePoll();
      fetchOutput();
    }

    function fetchOutput() {
      fetch(BASE + '/api/sessions/' + sessionId + '/output')
        .then(function(r) { return r.json(); })
        .then(function(d) {
          consecutiveErrors = 0;
          if (d.output !== prevOutput) {
            prevOutput = d.output;
            idleStart = Date.now();
            // Content changed — auto-trigger fast polling
            if (Date.now() >= fastPollEnd) {
              fastPollEnd = Date.now() + FAST_DURATION;
            }
            var el = document.getElementById('text-output');
            var atBot = el.scrollHeight - el.scrollTop - el.clientHeight < 40;
            el.innerHTML = ansiToHtml(d.output);
            if (atBot) el.scrollTop = el.scrollHeight;
          }
        }).catch(function() { consecutiveErrors++; });
    }

    // ---- Resize tmux pane ----
    function resizePane() {
      var el = document.getElementById('text-output');
      var cs = getComputedStyle(el);
      var padL = parseFloat(cs.paddingLeft) || 0;
      var padR = parseFloat(cs.paddingRight) || 0;
      var padT = parseFloat(cs.paddingTop) || 0;
      var padB = parseFloat(cs.paddingBottom) || 0;
      var usableW = el.clientWidth - padL - padR;
      var usableH = el.clientHeight - padT - padB;

      // 動態測量字元尺寸（掛在 el 內繼承 monospace 字體）
      var probe = document.createElement('span');
      probe.style.cssText = 'position:absolute;visibility:hidden;white-space:pre';
      probe.textContent = 'MMMMMMMMMM';
      el.appendChild(probe);
      var charW = probe.offsetWidth / 10;
      var charH = probe.offsetHeight || 18;
      el.removeChild(probe);

      var cols = Math.floor(usableW / charW) - 1;
      var rows = Math.floor(usableH / charH);
      if (cols > 10 && rows > 5) {
        api('POST', BASE + '/api/sessions/' + sessionId + '/resize', { cols: cols, rows: rows });
      }
    }

    // ---- Extended panel focus/blur ----
    document.getElementById('cmd-input').addEventListener('focus', function() {
      document.getElementById('extended-panel').classList.add('open');
      setTimeout(resizePane, 250);
    });
    document.getElementById('cmd-input').addEventListener('blur', function() {
      setTimeout(function() {
        if (document.activeElement.id !== 'cmd-input') {
          document.getElementById('extended-panel').classList.remove('open');
          setTimeout(resizePane, 250);
        }
      }, 200);
    });

    // ---- Settings ----
    function toggleSettings() { document.getElementById('settings-overlay').classList.toggle('open'); }
    function toggleUploadMode() {
      uploadModeA = !uploadModeA;
      var t = document.getElementById('toggle-upload-mode');
      if (uploadModeA) t.classList.add('on'); else t.classList.remove('on');
      try { localStorage.setItem('gt_upload_mode', uploadModeA ? 'A' : 'B'); } catch(e){}
    }

    // ---- 18 Shortcuts (in extended panel) ----
    var shortcuts = [
      {l:'Tab',k:'Tab'},{l:'S-Tab',k:'BTab'},
      {l:'\u2191',k:'Up'},{l:'\u2193',k:'Down'},{l:'\u2190',k:'Left'},{l:'\u2192',k:'Right'},
      {l:'Ctrl+C',k:'C-c'},{l:'Ctrl+B',k:'C-b'},
      {l:'Enter',k:'Enter'},{l:'Esc',k:'Escape'},
      {l:'Ctrl+U',k:'C-u'},{l:'Ctrl+K',k:'C-k'},{l:'Ctrl+W',k:'C-w'},
      {l:'Ctrl+D',k:'C-d',d:true},{l:'Ctrl+Z',k:'C-z',d:true},
      {l:'Ctrl+O',k:'C-o'},{l:'Clear',k:'C-l'},{l:'Search',k:'C-r'}
    ];
    (function() {
      var bar = document.getElementById('shortcut-bar');
      for (var i = 0; i < shortcuts.length; i++) {
        var s = shortcuts[i], btn = document.createElement('button');
        btn.className = 'shortcut-btn' + (s.d ? ' danger' : '');
        btn.textContent = s.l;
        if (s.d) {
          btn.dataset.key = s.k;
          btn.addEventListener('touchstart', dangerDown);
          btn.addEventListener('touchend', dangerUp);
          btn.addEventListener('touchcancel', dangerUp);
          btn.addEventListener('mousedown', dangerDown);
          btn.addEventListener('mouseup', dangerUp);
          btn.addEventListener('mouseleave', dangerUp);
        } else {
          btn.onclick = (function(k) { return function() { sendKey(k); }; })(s.k);
        }
        bar.appendChild(btn);
      }
    })();
    var _dt = null;
    function dangerDown(e) {
      e.preventDefault(); var btn = this, k = btn.dataset.key;
      btn.style.background = '#7f1d1d';
      _dt = setTimeout(function() { sendKey(k); btn.style.background = ''; }, 300);
    }
    function dangerUp() { if (_dt) { clearTimeout(_dt); _dt = null; } this.style.background = ''; }

    // ---- API ----
    function api(m, u, b) {
      var o = {method:m, headers:{'Content-Type':'application/json'}};
      if (b) o.body = JSON.stringify(b);
      return fetch(u, o).then(function(r) { if (r.status===401){window.location.href=BASE+'/';return{};} return r.json(); });
    }
    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function sendKey(k) {
      api('POST', BASE+'/api/sessions/'+sessionId+'/key', {key:k});
      triggerFastPoll();
    }

    function sendInput() {
      var input = document.getElementById('cmd-input'), text = input.value;
      var uploading = stagedFiles.filter(function(f){return f.status==='uploading';});
      if (uploading.length > 0) {
        document.getElementById('btn-send').disabled = true;
        document.getElementById('btn-send').textContent = '...';
        var to = setTimeout(function() { document.getElementById('btn-send').disabled=false; document.getElementById('btn-send').textContent='\u25b6'; alert('Upload took too long.'); }, 30000);
        var ci = setInterval(function() {
          if (!stagedFiles.filter(function(f){return f.status==='uploading';}).length) {
            clearInterval(ci); clearTimeout(to); document.getElementById('btn-send').disabled=false; document.getElementById('btn-send').textContent='\u25b6'; doSend(text);
          }
        }, 200);
        return;
      }
      var pending = stagedFiles.filter(function(f){return f.status==='pending';});
      if (pending.length) {
        document.getElementById('btn-send').disabled = true;
        document.getElementById('btn-send').textContent = '...';
        for (var i=0;i<pending.length;i++) uploadFile(pending[i]);
        var to2 = setTimeout(function(){document.getElementById('btn-send').disabled=false;document.getElementById('btn-send').textContent='\u25b6';alert('Upload took too long.');},30000);
        var ci2 = setInterval(function(){
          if(!stagedFiles.filter(function(f){return f.status==='uploading'||f.status==='pending';}).length){
            clearInterval(ci2);clearTimeout(to2);document.getElementById('btn-send').disabled=false;document.getElementById('btn-send').textContent='\u25b6';doSend(text);
          }
        },200);
        return;
      }
      doSend(text);
    }

    function doSend(text) {
      var parts = [];
      if (text) parts.push(text);
      var done = stagedFiles.filter(function(f){return f.status==='done'&&f.serverPath;});
      for (var i=0;i<done.length;i++) parts.push('[Attached: '+done[i].serverPath+']');
      var composed = parts.join('\n');
      if (!composed) return;
      api('POST', BASE+'/api/sessions/'+sessionId+'/input', {text:composed});
      document.getElementById('cmd-input').value = '';
      stagedFiles = []; renderChips();
      triggerFastPoll();
    }

    // ---- Upload ----
    function handleFiles(fl) {
      for (var i=0;i<fl.length;i++) {
        var f = fl[i];
        var e = {id:Math.random().toString(36).substr(2,9),file:f,name:f.name,size:f.size,
          status:'pending',xhr:null,serverFilename:null,serverPath:null,progress:0};
        stagedFiles.push(e);
        if (uploadModeA || f.size > 50*1024*1024) uploadFile(e);
      }
      renderChips();
      document.getElementById('file-input').value = '';
      document.getElementById('cam-input').value = '';
    }

    function uploadFile(entry) {
      entry.status='uploading'; activeUploads++; renderChips();
      if (entry.size >= 5*1024*1024) { uploadChunked(entry); return; }
      var fd = new FormData(); fd.append('file', entry.file);
      var xhr = new XMLHttpRequest(); entry.xhr = xhr;
      xhr.upload.onprogress = function(e) { if (e.lengthComputable) { entry.progress = Math.round(e.loaded/e.total*100); renderChips(); } };
      xhr.onload = function() {
        activeUploads--;
        if (xhr.status===200) { var r=JSON.parse(xhr.responseText); entry.status='done'; entry.serverFilename=r.filename; entry.serverPath=r.path; }
        else entry.status='error';
        renderChips();
      };
      xhr.onerror = function() { activeUploads--; entry.status='error'; renderChips(); };
      xhr.open('POST', BASE+'/api/sessions/'+sessionId+'/upload'); xhr.send(fd);
    }

    function uploadChunked(entry) {
      var CS=5*1024*1024, total=Math.ceil(entry.file.size/CS), fid=entry.id, idx=0;
      function next() {
        if (idx>=total) { activeUploads--; entry.status='done';
          api('GET',BASE+'/api/sessions/'+sessionId+'/files').then(function(files){
            if(files&&files.length){var l=files[files.length-1];entry.serverFilename=l.filename;entry.serverPath=l.path;}
            renderChips();
          }); return;
        }
        var s=idx*CS, e=Math.min(s+CS,entry.file.size);
        var fd=new FormData();
        fd.append('chunk',entry.file.slice(s,e));
        fd.append('fileId',fid); fd.append('chunkIndex',String(idx));
        fd.append('totalChunks',String(total)); fd.append('fileName',entry.file.name);
        var xhr=new XMLHttpRequest();
        xhr.onload=function(){ if(xhr.status===200){idx++;entry.progress=Math.round(idx/total*100);renderChips();next();}else{entry.status='error';activeUploads--;renderChips();}};
        xhr.onerror=function(){setTimeout(next,2000);};
        xhr.open('POST',BASE+'/api/sessions/'+sessionId+'/upload/chunk'); xhr.send(fd);
      }
      next();
    }

    function removeFile(id) {
      var idx=stagedFiles.findIndex(function(f){return f.id===id;}); if(idx===-1)return;
      var e=stagedFiles[idx];
      if(e.xhr&&e.status==='uploading'){e.xhr.abort();activeUploads--;}
      if(e.serverFilename) fetch(BASE+'/api/sessions/'+sessionId+'/files/'+e.serverFilename,{method:'DELETE'});
      stagedFiles.splice(idx,1); renderChips();
    }

    function renderChips() {
      var c=document.getElementById('staged-files'), h='';
      for (var i=0;i<stagedFiles.length;i++) {
        var f=stagedFiles[i];
        var sz=f.size<1024?f.size+'B':f.size<1048576?Math.round(f.size/1024)+'KB':Math.round(f.size/1048576)+'MB';
        var pr=f.status==='uploading'?' '+f.progress+'%':'';
        h+='<span class="file-chip '+f.status+'">'+escapeHtml(f.name.length>20?f.name.substring(0,18)+'..':f.name)
          +' <span class="size">'+sz+pr+'</span> <span class="remove" onclick="removeFile(\''+f.id+'\')">&times;</span></span>';
      }
      c.innerHTML = h;
      var pg=document.getElementById('upload-progress');
      var ups=stagedFiles.filter(function(f){return f.status==='uploading';});
      if(ups.length){var t=0;for(var j=0;j<ups.length;j++)t+=ups[j].progress;
        pg.innerHTML='<div class="bar" style="width:'+Math.round(t/ups.length)+'%"></div>';
      } else pg.innerHTML='';
    }

    // Restore files
    (function(){
      api('GET',BASE+'/api/sessions/'+sessionId+'/files').then(function(files){
        if(!files||!files.length)return;
        for(var i=0;i<files.length;i++){
          stagedFiles.push({id:Math.random().toString(36).substr(2,9),file:null,
            name:files[i].filename,size:files[i].size,status:'done',xhr:null,
            serverFilename:files[i].filename,serverPath:files[i].path,progress:100});
        }
        renderChips();
      });
    })();

    // Navigation
    function goHome() { window.location.href = BASE + '/'; }
    function doLogout() {
      api('POST',BASE+'/api/auth/logout').then(function(){
        try{var x=new XMLHttpRequest();x.open('GET',window.location.origin+'/console/',true,'logout','logout');x.send();}catch(e){}
        setTimeout(function(){window.location.href='/console/';},300);
      });
    }

    // Enter key
    document.getElementById('cmd-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); sendInput(); }
    });

    // SSE for status
    var _sse = null;
    function connectSSE() {
      if (_sse) { _sse.close(); _sse = null; }
      var es = new EventSource(BASE + '/api/sessions/stream'); _sse = es;
      es.onmessage = function(e) {
        try { var d = JSON.parse(e.data);
          for (var i=0;i<d.sessions.length;i++) {
            if (d.sessions[i].id === sessionId) {
              document.getElementById('status-dot').className = 'status-dot status-' + d.sessions[i].status;
              if (d.sessions[i].name) document.getElementById('title').textContent = d.sessions[i].name;
            }
          }
        } catch(err){}
      };
      es.onerror = function() { es.close(); _sse = null; setTimeout(connectSSE, 5000); };
    }
    connectSSE();
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) { if (_sse) { _sse.close(); _sse = null; } stopPoll(); }
      else { connectSSE(); startPoll(); }
    });
    window.addEventListener('pageshow', function(e) { if (e.persisted) { connectSSE(); startPoll(); } });

    // GDrive
    function pollGD() {
      api('GET',BASE+'/api/gdrive/status').then(function(s){
        var d=document.getElementById('gdrive-dot');
        if(s.mounted){d.className='gdrive-dot mounted';d.title='GDrive: Mounted';}
        else{d.className='gdrive-dot unmounted';d.title='GDrive: NOT Mounted';}
      });
    }
    pollGD(); setInterval(pollGD, 30000);

    window.addEventListener('beforeunload', function(e) {
      if (activeUploads > 0) { e.preventDefault(); e.returnValue = 'Uploads in progress.'; }
    });

    // Resize on orientation change / window resize
    var _resizeDebounce = null;
    window.addEventListener('resize', function() {
      clearTimeout(_resizeDebounce);
      _resizeDebounce = setTimeout(resizePane, 300);
    });

    // ---- Clipboard paste (button + passive event) ----
    function pasteClipboard() {
      if (navigator.clipboard && navigator.clipboard.read) {
        navigator.clipboard.read().then(function(items) {
          var handled = false;
          for (var i = 0; i < items.length; i++) {
            var types = items[i].types;
            for (var t = 0; t < types.length; t++) {
              if (types[t].indexOf('image/') === 0) {
                items[i].getType(types[t]).then(function(blob) {
                  var fname = 'clipboard-' + Date.now() + '.' + (blob.type.split('/')[1] || 'png');
                  var file = new File([blob], fname, {type: blob.type});
                  handleFiles([file]);
                });
                handled = true; break;
              }
            }
            if (handled) break;
          }
          if (!handled) {
            // No image found, try text
            navigator.clipboard.readText().then(function(t) {
              if (t) document.getElementById('cmd-input').value += t;
            });
          }
        }).catch(function() {
          navigator.clipboard.readText().then(function(t) {
            if (t) document.getElementById('cmd-input').value += t;
          }).catch(function(){});
        });
      } else if (navigator.clipboard && navigator.clipboard.readText) {
        navigator.clipboard.readText().then(function(t) {
          if (t) document.getElementById('cmd-input').value += t;
        }).catch(function(){});
      }
    }

    // Passive paste event — intercept image paste anywhere on page
    document.addEventListener('paste', function(e) {
      var items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image/') === 0) {
          e.preventDefault();
          var blob = items[i].getAsFile();
          if (blob) {
            var fname = 'clipboard-' + Date.now() + '.' + (blob.type.split('/')[1] || 'png');
            var file = new File([blob], fname, {type: blob.type});
            handleFiles([file]);
          }
          return;
        }
      }
      // Text paste — let default behavior handle if cmd-input is focused
      var active = document.activeElement;
      if (!active || active.id !== 'cmd-input') {
        // Paste text into cmd-input even if not focused
        for (var j = 0; j < items.length; j++) {
          if (items[j].type === 'text/plain') {
            e.preventDefault();
            items[j].getAsString(function(t) {
              if (t) document.getElementById('cmd-input').value += t;
            });
            return;
          }
        }
      }
    });

    // ---- Terminal click-to-focus ----
    document.getElementById('text-output').addEventListener('click', function() {
      if (window.getSelection().toString().length === 0) {
        document.getElementById('cmd-input').focus();
      }
    });

    // Start polling immediately and resize pane
    startPoll();
    setTimeout(resizePane, 500);
  </script>
</body>
</html>
